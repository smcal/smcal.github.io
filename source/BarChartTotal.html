<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>California Wildfires 1992 - 2015</title>
    <script type="text/javascript" src="../libs/d3.js"></script>

    <style type="text/css">
        rect:hover {
            fill: orange;
        }

        #tooltip {
            position: absolute;
            width: 200px;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }

        #tooltip.hidden {
            display: none;
        }

        #tooltip p {
            margin: 0;
            font-family: sans-serif;
            font-size: 16px;
            line-height: 20px;
        }

    </style>

</head>
<body>

<div id="tooltip" class="hidden">
    <p><strong>Total Acres Burned from <span id="value"></span></strong></p>
</div>
<div id="titleheader">
<p><h2>Total Acres Burned for <span id="myyears"></span></h2>
    <select class="yearlist"><option>All Years</option></select></p>
</div>

<script type="text/javascript">

    var w = 600;
    var h = 650;
    var count = 0;
    var fireSize = [];

    var year = {};
    var myYear = [];
    var dataset = [];

    var formatAsThousands = d3.format(",");

    var q = d3.queue();
    q.defer(function (callback) {
        d3.csv("../data/CaliforniaFires.csv", function (res) {
            callback(null, res);
        });

    });

    q.await(restOfCode);

    function restOfCode(err, results) {
        for (var i = 0; i < results.length; ++i) {
            if (!isNaN(dataset[results[i].Fire_Cause])) {
                year[results[i].Fire_Year] = 1;
                dataset[results[i].Fire_Cause] += Math.floor(Math.round(parseFloat(results[i].Fire_Size)));
            }
            else {
                dataset[results[i].Fire_Cause] = 0;
            }
        }

        // All year option takes space in enter so add dummy entry
        myYear.push(0);
        for (var key in year) {
            myYear.push(key);
        };

        d3.select(".yearlist")
            .selectAll('option')
            .data(myYear).enter()
            .append('option')
            .text(function (d) {
                return d;
            });

        var displayData = [];
        for (var key in dataset) {
            fireSize.push(dataset[key]);
            displayData.push({"key": key, "value": dataset[key]});
            count++;
        }

        var key = function (d) {
            return d.value;
        };
        var xScale = d3.scaleBand()
            .domain(d3.range(count))
            .rangeRound([0, w])
            .paddingInner(0.05);

        var yScale = d3.scaleLinear()
            .domain([0, d3.max(fireSize)])
            .range([0, h]);

        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        //Create bars
        svg.selectAll("rect")
            .data(displayData, key)
            .enter()
            .append("rect")
            .attr("x", function (d, i) {
                return xScale(i);
            })
            .attr("y", function (d) {
                return h - yScale(d.value);
            })
            .attr("width", xScale.bandwidth())
            .attr("height", function (d) {
                return yScale(d.value);
            })
            .attr("fill", function (d) {
                return "rgb(0, 0, " + Math.round(d.value * 10) + ")";
            })
            .on("mouseover", function (d) {

                //Get this bar's x/y values, then augment for the tooltip
                var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.bandwidth() / 2;
                var yPosition = parseFloat(d3.select(this).attr("y")) / 2 + h / 2;

                //Update the tooltip position and value
                d3.select("#tooltip")
                    .style("left", xPosition + "px")
                    .style("top", yPosition + "px")
                    .select("#value")
                    .text(d.key + " " + formatAsThousands(d.value));

                //Show the tooltip
                d3.select("#tooltip").classed("hidden", false);

            })
            .on("mouseout", function () {

                //Hide the tooltip
                d3.select("#tooltip").classed("hidden", true);

            })
            .on("click", function () {
                sortBars();
            });

        d3.select("#titleheader")
            .select("#myyears")
            .text(d3.select(".yearlist").property('value'));

        //Define sort order flag
        var sortOrder = true;

        //Define sort function
        var sortBars = function () {

            //Flip value of sortOrder
            sortOrder = !sortOrder;

            svg.selectAll("rect")
                .sort(function (a, b) {
                    if (sortOrder) {
                        return d3.ascending(a.value, b.value);
                    } else {
                        return d3.descending(a.value, b.value);
                    }
                })
                .transition()
                .delay(function (d, i) {
                    return i * 50;
                })
                .duration(1000)
                .attr("x", function (d, i) {
                    return xScale(i);
                });
        };

        // Sort from the get-go and allow users to flip
        sortBars();

        d3.select(".yearlist")
            .on("change", function (d) {
                dataset.fill(0);
                for (var i = 0; i < results.length; ++i)
                {
                    if (results[i].Fire_Year == d3.select(".yearlist").property('value'))
                    {
                        dataset[results[i].Fire_Cause] += Math.floor(Math.round(parseFloat(results[i].Fire_Size)));
                    }
                    else if (d3.select(".yearlist").property('value') === "All Years")
                    {
                        // we are at all year selection
                        dataset[results[i].Fire_Cause] += Math.floor(Math.round(parseFloat(results[i].Fire_Size)));
                    }
                }

                svg.selectAll("rect").remove();
                var displayData = [];
                for (var key in dataset) {
                    fireSize.push(dataset[key]);
                    displayData.push({"key": key, "value": dataset[key]});
                    count++;
                }
                var key = function (d) {
                    return d.value;
                };

                //Create bars
                svg.selectAll("rect")
                    .data(displayData, key)
                    .enter()
                    .append("rect")
                    .attr("x", function (d, i) {
                        return xScale(i);
                    })
                    .attr("y", function (d) {
                        return h - yScale(d.value);
                    })
                    .attr("width", xScale.bandwidth())
                    .attr("height", function (d) {
                        return yScale(d.value);
                    })
                    .attr("fill", function (d) {
                        return "rgb(0, 0, " + Math.round(d.value * 10) + ")";
                    })
                    .on("mouseover", function (d) {

                        //Get this bar's x/y values, then augment for the tooltip
                        var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.bandwidth() / 2;
                        var yPosition = parseFloat(d3.select(this).attr("y")) / 2 + h / 2;

                        //Update the tooltip position and value
                        d3.select("#tooltip")
                            .style("left", xPosition + "px")
                            .style("top", yPosition + "px")
                            .select("#value")
                            .text(d.key + " " + formatAsThousands(d.value));

                        //Show the tooltip
                        d3.select("#tooltip").classed("hidden", false);

                    })
                    .on("mouseout", function () {

                        //Hide the tooltip
                        d3.select("#tooltip").classed("hidden", true);

                    })
                    .on("click", function () {
                        sortBars();
                    });

                //Define sort order flag
                var sortOrder = true;

                //Define sort function
                var sortBars = function ()
                {
                    //Flip value of sortOrder
                    sortOrder = !sortOrder;

                    svg.selectAll("rect")
                        .sort(function (a, b) {
                            if (sortOrder) {
                                return d3.ascending(a.value, b.value);
                            } else {
                                return d3.descending(a.value, b.value);
                            }
                        })
                        .transition()
                        .delay(function (d, i) {
                            return i * 50;
                        })
                        .duration(1000)
                        .attr("x", function (d, i) {
                            return xScale(i);
                        });
                }

                sortBars();
                d3.select("#titleheader")
                    .select("#myyears")
                    .text(d3.select(".yearlist").property('value'));
            });
    };

</script>

</body>
</html>